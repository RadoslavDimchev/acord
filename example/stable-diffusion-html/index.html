<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC Stable Diffusion Acord demo</title>
    <style>
        /* Google Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        /* Reset & Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
        }

        /* Main Container */
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 420px;
            width: 100%;
            text-align: center;
            color: white;
        }

        h1 {
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Input Fields */
        .input-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
            text-align: center;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        input:focus {
            outline: none;
            border-color: #4caf50;
            background: rgba(255, 255, 255, 0.2);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #4caf50, #2e7d32);
            color: white;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: linear-gradient(90deg, #66bb6a, #388e3c);
            transform: scale(1.02);
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Status Message */
        #status {
            font-size: 14px;
            margin-top: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        #imgResult {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Image Generator</h1>

        <div class="input-box" id="modelBox">
            <input type="text" id="model" placeholder="Enter Model Path">
            <button class="btn" id="loadBtn" onclick="loadModel()">Load Model</button>
        </div>

        <div class="input-box">
            <input type="text" id="prompt" placeholder="Enter Prompt">
            <button class="btn" id="genBtn" onclick="sendPrompt()">Generate Image</button>
        </div>

        <p id="status">Waiting for input...</p>

        <img id="imgResult" />
    </div>

    <script>
        const LOG_LEVLEL = {
            INFO: 0,
            SUCCESS: 1,
            ERROR: 2
        }

        function setStatus(message, level) {
            const status = document.getElementById("status");
            status.innerText = message;
            if (level == LOG_LEVLEL.INFO) {
                status.style.color = "white";
            } else if (level == LOG_LEVLEL.SUCCESS) {
                status.style.color = "green";
            } else if (level == LOG_LEVLEL.ERROR) {
                status.style.color = "red";
            }
        }

        const AC_STATES = {
            CONNECTED: 0,
            INITIALIZED: 1,
            MODEL_LOADED: 2,
            INSTANCE_STARTED: 3,
            GENERATION: 4,
            DISCONNECTED: 5
        };

        let acState = AC_STATES.ERROR;

        const localhost = "ws://localhost:7654";

        // Connect directly to Acord WebSocket
        const ws = new WebSocket(localhost);

        ws.onopen = () => {
            console.log("Connected to Stable Diffusion WebSocket.");
            setStatus("Connected!", LOG_LEVLEL.SUCCESS);
            acState = AC_STATES.CONNECTED;
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            setStatus(`Error: Couldn't make web socket connection to ${localhost}! Start the server...`, LOG_LEVLEL.ERROR);
            acState = AC_STATES.DISCONNECTED;
        };

        ws.onmessage = async (event) => {
            const response = JSON.parse(event.data);
            console.log(response);
        };

        function fillImageData(data) {
            const c = document.createElement("canvas");
            c.width = data.width;
            c.height = data.height;

            const ctx = c.getContext("2d");
            const imageData = ctx.createImageData(data.width, data.height);

            // Fill imageData with raw bytes
            let colorI = 0
            for (let i = 0; i < imageData.data.length; i+=4) {

                // Check if data is available
                if (data.data) {
                    imageData.data[i] = data.data.bytes[colorI];
                    imageData.data[i + 1] = data.data.bytes[colorI + 1];
                    imageData.data[i + 2] = data.data.bytes[colorI + 2];
                    imageData.data[i + 3] = 255;
                }
                else{
                    imageData.data[i] = Math.ceil(Math.random() * 255);
                    imageData.data[i + 1] = Math.ceil(Math.random() * 255);
                    imageData.data[i + 2] = Math.ceil(Math.random() * 255);
                    imageData.data[i + 3] = 255;
                }
                colorI += 3;
            }

            // // Draw the image on the canvas
            ctx.putImageData(imageData, 0, 0);
            var image = new Image();
            image.id = "pic";
            image.src = c.toDataURL();
            let img = document.getElementById('imgResult');
            img.src = image.src;
        }

        async function sendRequest(data, errorCb) {
            const request = JSON.stringify(data);
            ws.send(request);
            console.log(`Op - ${data.op}: Started`);
            if (data.op === "textToImage") {
                return new Promise((resolve, reject) => {
                    ws.onmessage = (event) => {
                        const {data, op} = JSON.parse(event.data);
                        console.log(`Op - ${op}: Finished`);
                        resolve(data);
                    };
                });
            } else {
                return new Promise((resolve, reject) => {
                    ws.onmessage = (event) => {
                        const response = JSON.parse(event.data);
                        console.log(response);
                        if (response.op.startsWith("s:")) {
                            console.log(`Op - ${response.op}: Finished`);
                            // In the Acord we have 2 notifications
                            // 1 - the op itself and if there is an error
                            // 2 - the new state
                            // So we resolve only we receive the new state in order to continue
                            resolve(response);
                        } else {
                            console.log(`Op - ${response.op}: Received`);
                            if (response.op === "error") {
                                errorCb(response);
                                resolve(response);
                            }
                        }
                    };
                });
            }
       }

       async function prepare() {
           await sendRequest({
                    op: "load_provider",
                    data: {
                        name: "stable-diffusion.cpp"
                    }
                });

            acState = AC_STATES.INITIALIZED;
            console.log(`Provider stable-diffusion.cpp is initialized!`);
       }

       (async() => {
            while (ws.readyState !== WebSocket.OPEN) {
                await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            await prepare();
        })();

        async function loadModel() {
            if (ws.readyState !== WebSocket.OPEN) {
                setStatus("WebSocket are not connected!", LOG_LEVLEL.ERROR);
                return;
            }

            if (acState === AC_STATES.INSTANCE_STARTED) {
                setStatus("Model is already loaded. Refresh to load a new one.", LOG_LEVLEL.ERROR);
            }

            if (acState === AC_STATES.INITIALIZED) {
                let modelBox = document.getElementById("modelBox");
                let modelInput = document.getElementById("model");
                let modelLoadBtn = document.getElementById("loadBtn");

                let modelPath = modelInput.value;
                if (modelPath === "") {
                    setStatus("Please enter the path to the model!", LOG_LEVLEL.ERROR);
                    return;
                }

                // Disable load button button
                modelLoadBtn.disabled = true;
                modelLoadBtn.style.opacity = "0.6"; // Reduce opacity for a disabled look
                modelLoadBtn.style.pointerEvents = "none";

                setStatus("Loading...", LOG_LEVLEL.INFO);

                let loadingError = false;
                let handleError = (data) => {
                    setStatus(`Error loading model! Message: "${data.data}"`, LOG_LEVLEL.ERROR);
                    modelLoadBtn.disabled = false;
                    modelLoadBtn.style.opacity = "1";
                    modelLoadBtn.style.pointerEvents = "auto";
                    loadingError = true;
                }

                await sendRequest({
                        op: "load-model",
                        data: {
                            binPath: modelPath
                        }
                    }, handleError);

                if (loadingError) {
                    return;
                }

                acState = AC_STATES.MODEL_LOADED;
                console.log(`Model ${modelPath.split('/').at(-1)} loaded!`);

                await sendRequest({
                        op: "start-instance"
                    });

                acState = AC_STATES.INSTANCE_STARTED;
                console.log(`Instance started!`);

                setStatus("Model loaded!", LOG_LEVLEL.SUCCESS);

                let status = document.createElement("p");
                status.innerHTML = `Model \"${modelPath.split('/').at(-1)}\" is loaded! To load a new one refresh the page.`;
                status.style.color = "white";
                modelBox.appendChild(status);

                modelInput.style.display = "none";
                modelLoadBtn.style.display = "none";
            } else {
                document.getElementById("status").innerText = "Provider is not loaded yet!";
            }
        }

        async function sendPrompt() {
            const prompt = document.getElementById("prompt").value;
            if (ws.readyState !== WebSocket.OPEN) {
                setStatus("WebSocket are not connected!", LOG_LEVLEL.ERROR);
                return;
            }

            if (acState === AC_STATES.INSTANCE_STARTED) {
                setStatus("Generating...", LOG_LEVLEL.INFO);
                document.getElementById("genBtn").disabled = true;
                const responseData = await sendRequest({
                        op: "textToImage",
                        data: {
                            prompt: prompt,
                            width: 512,
                            height: 512
                        }
                    });
                fillImageData(responseData);
                setStatus("Generation Done! Try again with a new prompt.", LOG_LEVLEL.SUCCESS);
                document.getElementById("genBtn").disabled = false;
            } else {
                setStatus("Model is not loaded yet!", LOG_LEVLEL.ERROR);
            }
        }
    </script>
</body>
</html>
